# 后端架构设计文档

## 📋 项目概览

**项目名称**: 易宿酒店预订平台 - 后端服务  
**技术栈**: Express.js + TypeScript + MySQL + Sequelize  
**架构模式**: MVC 分层架构  
**状态**: 开发中 (数据库待部署)

---

## 🏗️ 系统架构

### 分层架构图

```
┌─────────────────────────────────────┐
│         HTTP 请求 (前端)            │
└──────────────┬──────────────────────┘
               ↓
┌──────────────────────────────────────────────────┐
│            Routes 路由层                         │
│  定义 HTTP 端点和请求路径                        │
│  - /api/user/login                              │
│  - /api/user/info                               │
│  - /api/user/logout                             │
└──────────────┬───────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────┐
│         Controllers 控制器层                     │
│  处理请求和响应                                  │
│  - 参数校验                                      │
│  - 调用服务层                                    │
│  - 返回统一格式响应                              │
└──────────────┬───────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────┐
│         Services 服务层                          │
│  业务逻辑实现                                    │
│  - 用户认证                                      │
│  - 数据处理                                      │
│  - 业务规则                                      │
└──────────────┬───────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────┐
│         Models 模型层 (Sequelize ORM)            │
│  数据模型定义和数据库映射                         │
│  - 表结构定义                                    │
│  - 字段映射                                      │
└──────────────┬───────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────┐
│         Database 数据库层                        │
│  MySQL 数据库 (待部署)                           │
│  - users 表                                      │
│  - 其他业务表                                    │
└──────────────────────────────────────────────────┘
```

### 跨越层的关键组件

```
├── Middleware 中间件
│   ├── authMiddleware - JWT 认证检验
│   └── errorHandler - 统一错误处理
│
├── Utils 工具函数
│   ├── auth.ts - 加密、JWT、密码验证
│   └── response.ts - 统一响应格式
│
├── Types TypeScript 类型
│   └── index.ts - 接口和类型定义
│
└── Config 配置
    └── database.ts - 数据库配置
```

---

## 📂 项目文件结构

```
packages/backend/
│
├── src/
│   ├── app.ts                      ← Express 应用入口
│   │
│   ├── config/
│   │   └── database.ts             ← 数据库配置（支持延迟初始化）
│   │
│   ├── controllers/
│   │   └── UserController.ts       ← 用户请求处理
│   │
│   ├── services/
│   │   └── UserService.ts          ← 用户业务逻辑
│   │
│   ├── models/
│   │   └── User.ts                 ← User 数据模型
│   │
│   ├── routes/
│   │   ├── index.ts                ← 路由聚合
│   │   └── userRoutes.ts           ← 用户相关路由
│   │
│   ├── middleware/
│   │   └── auth.ts                 ← 认证和错误处理中间件
│   │
│   ├── types/
│   │   └── index.ts                ← TypeScript 类型定义
│   │
│   └── utils/
│       ├── auth.ts                 ← 加密和 JWT 工具
│       └── response.ts             ← 统一响应格式工具
│
├── db/
│   └── init.sql                    ← 数据库初始化脚本
│
├── .env                            ← 环境变量（开发）
├── .env.example                    ← 环境变量模板
├── package.json                    ← 项目依赖
├── tsconfig.json                   ← TypeScript 配置
└── README.md                       ← 项目说明
```

---

## 🔄 数据流程

### 用户登录流程

```
1. 前端发送请求
   POST /api/user/login
   Body: { username, password }
       ↓
2. Routes 路由层
   找到对应的路由处理器
       ↓
3. Controllers 控制器层
   ├─ 参数验证
   └─ 调用 UserService.login()
       ↓
4. Services 服务层
   ├─ 查询用户信息
   ├─ 验证密码 (bcryptjs)
   └─ 生成 JWT Token
       ↓
5. 返回响应
   {
     "code": 200,
     "message": "登录成功",
     "data": {
       "token": "eyJh...",
       "userInfo": {...},
       "expireTime": 7200
     }
   }
```

### 获取用户信息流程

```
1. 前端发送带 Token 的请求
   GET /api/user/info
   Header: Authorization: Bearer {token}
       ↓
2. Middleware 中间件
   ├─ authMiddleware 验证 Token
   ├─ 解析 JWT 获取 userId
   └─ 将用户信息添加到 req.user
       ↓
3. Routes 路由层
   找到对应的路由处理器
       ↓
4. Controllers 控制器层
   └─ 调用 UserService.getUserInfo(userId)
       ↓
5. Services 服务层
   └─ 从数据库查询用户信息
       ↓
6. 返回响应
   {
     "code": 200,
     "message": "获取成功",
     "data": {
       "userId": 1,
       "username": "admin",
       ...
     }
   }
```

---

## 🔐 认证机制

### JWT Token 流程

```
用户登录
    ↓
验证凭证正确
    ↓
生成 JWT Token
  ├─ Payload: { userId, username, role }
  ├─ Secret: JWT_SECRET (环境变量)
  └─ Expires: 2 小时
    ↓
返回 Token 给前端
    ↓
前端保存 Token (localStorage)
    ↓
后续请求带上 Token
  └─ Authorization: Bearer {token}
    ↓
后端验证 Token
  ├─ 检查格式
  ├─ 验证签名
  └─ 检查过期时间
    ↓
允许访问
```

### 密码加密

```
前端:
  明文密码 ──(MD5)──> 密文

后端:
  接收密文 ──(bcryptjs.compare)──> 验证匹配
  存储时 ──(bcryptjs.hash)──> 加密存储
```

---

## 📊 数据库设计

### users 表结构

```sql
CREATE TABLE users (
  userId INT PRIMARY KEY AUTO_INCREMENT,      -- 用户ID
  username VARCHAR(50) UNIQUE NOT NULL,       -- 用户名
  password VARCHAR(255) NOT NULL,             -- 加密密码
  nickname VARCHAR(100),                      -- 昵称
  email VARCHAR(100),                         -- 邮箱
  phone VARCHAR(20),                          -- 电话
  avatar VARCHAR(255),                        -- 头像
  role ENUM('super_admin','admin','user'),   -- 角色
  status ENUM('active','inactive'),          -- 状态
  createTime TIMESTAMP DEFAULT NOW(),         -- 创建时间
  updateTime TIMESTAMP DEFAULT NOW()          -- 更新时间
);
```

### 角色权限

```
super_admin   - 超级管理员 (全部权限)
admin         - 普通管理员 (部分权限)
user          - 普通用户   (基础权限)
```

---

## 🎯 API 接口

详见 [后端接口设计](后端接口设计.md) 文档。

主要实现的接口：
- `POST /api/user/login` - 用户登录
- `GET /api/user/info` - 获取用户信息
- `POST /api/user/logout` - 退出登录

---

## 🛠️ 技术栈详解

### 核心框架
- **Express.js 4.18.2** - 轻量级 Web 框架
- **TypeScript 5.3.3** - 类型安全语言

### 数据库
- **Sequelize 6.35.2** - ORM 框架
- **MySQL2 3.6.5** - MySQL 驱动
- **MySQL 8.0+** - 关系型数据库

### 认证和安全
- **jsonwebtoken 9.1.2** - JWT Token 实现
- **bcryptjs 2.4.3** - 密码加密库

### 其他工具
- **cors 2.8.5** - 跨域支持
- **axios 1.6.2** - HTTP 客户端
- **joi 17.11.0** - 数据验证

---

## 🔌 扩展指南

### 添加新接口步骤

#### 1. 创建路由 (src/routes/)
```typescript
router.get('/hotels', (req, res) => 
  HotelController.getHotels(req, res)
);
```

#### 2. 创建控制器 (src/controllers/)
```typescript
async getHotels(req: Request, res: Response) {
  const hotels = await HotelService.getHotels();
  successResponse(res, hotels);
}
```

#### 3. 创建服务 (src/services/)
```typescript
async getHotels() {
  return await Hotel.findAll();
}
```

#### 4. 创建模型 (src/models/)
```typescript
class Hotel extends Model {
  // 定义表结构
}
```

---

## 📝 环境变量

```env
# 服务器配置
PORT=8080
NODE_ENV=development

# 数据库配置
DB_ENABLED=false              # 设为 true 启用数据库
DB_HOST=localhost
DB_PORT=3306
DB_NAME=easy_inn_booking
DB_USER=root
DB_PASSWORD=password

# JWT 配置
JWT_SECRET=secret-key
JWT_EXPIRES_IN=2h
```

---

## ✨ 关键特性

✅ **类型安全** - 完整的 TypeScript 类型定义  
✅ **分层架构** - 清晰的代码结构和职责分工  
✅ **安全认证** - JWT + bcryptjs 双重保障  
✅ **统一响应** - 所有接口返回统一格式  
✅ **错误处理** - 完整的异常捕获和处理  
✅ **可扩展性** - 模块化设计，易于扩展  
✅ **待部署状态** - 支持在无数据库的情况下启动

---

## 🚀 后续开发

### 短期 (1-2 周)
- [ ] 部署 MySQL 数据库
- [ ] 启用数据库连接 (DB_ENABLED=true)
- [ ] 测试认证接口

### 中期 (2-3 周)
- [ ] 酒店管理接口 (GET/POST/PUT/DELETE)
- [ ] 房间管理接口
- [ ] 预订管理接口

### 长期 (3+ 周)
- [ ] 支付集成
- [ ] 评价评分
- [ ] 搜索和筛选
- [ ] 单元测试
- [ ] API 文档 (Swagger)

---

**文档更新时间**: 2026-02-05  
**版本**: 1.0.0
